apiVersion: v1
kind: Pod
metadata:
  name: redisconnect
  labels:
    app: redisconnect
spec:
  containers:
    # Go Server Container
    - name: go-server
      image: redisconnect-go-server:latest
      imagePullPolicy: Never # Use local image loaded with kind
      ports:
        - name: http
          containerPort: 5000
          protocol: TCP
      env:
        - name: APP_PORT
          value: '5000'
        - name: HOST
          valueFrom:
            secretKeyRef:
              name: redisconnect-secrets
              key: redis-host
        - name: PORT
          value: '6379'
        - name: PASSWORD
          valueFrom:
            secretKeyRef:
              name: redisconnect-secrets
              key: redis-password
        - name: REDIS_USERNAME
          value: 'default'
        - name: HIGMA_API_URL
          valueFrom:
            secretKeyRef:
              name: redisconnect-secrets
              key: higma-api-url
      resources:
        limits:
          memory: '256Mi'
          cpu: '500m'
        requests:
          memory: '128Mi'
          cpu: '250m'
      livenessProbe:
        httpGet:
          path: /
          port: 5000
        initialDelaySeconds: 10
        periodSeconds: 30
      readinessProbe:
        httpGet:
          path: /
          port: 5000
        initialDelaySeconds: 5
        periodSeconds: 10

    # GoSignaling Container
    - name: gosignaling
      image: redisconnect-gosignaling:latest
      imagePullPolicy: Never # Use local image loaded with kind
      ports:
        - name: ws
          containerPort: 8080
          protocol: TCP
      args:
        - '-addr'
        - '0.0.0.0'
        - '-port'
        - '8080'
      resources:
        limits:
          memory: '128Mi'
          cpu: '250m'
        requests:
          memory: '64Mi'
          cpu: '100m'
      livenessProbe:
        tcpSocket:
          port: 8080
        initialDelaySeconds: 10
        periodSeconds: 30
      readinessProbe:
        tcpSocket:
          port: 8080
        initialDelaySeconds: 5
        periodSeconds: 10

  restartPolicy: Always
